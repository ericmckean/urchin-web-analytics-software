## Please edit system and help pages ONLY in the moinmaster wiki! For more
## information, please see MoinMaster:MoinPagesEditorGroup.
##acl MoinPagesEditorGroup:read,write,delete,revert All:read
##master-page:HelpTemplate
##master-date:Unknown-Date
#format wiki
#language en
'''Пользовательские журналы электронной торговли'''

'''Обзор'''

Во многих корзинах покупок предусмотрена возможность сбора и регистрации ценной информации о покупках в форматах, отличных от ELF2, из-за чего эти данные не могут быть автоматически обработаны программой Urchin. В данной статье объясняется, как создать пользовательский формат журнала для файла журнала электронной торговли, если вы не можете настроить в корзине покупок использование формата ELF2. Прежде чем продолжить, прочитайте раздел ["Пользовательские форматы журнала"], в котором более подробно объясняется процесс создания пользовательских журналов.

'''Типы форматов журнала электронной торговли'''

В корзинах покупок информация о покупках и приобретенных товарных единицах может загружаться как в однострочном, так и в многострочном формате. В однострочном формате каждая строка содержит всю информацию, необходимую для полного описания транзакции и приобретенных товарных единиц, при этом все строки имеют одинаковый формат. В многострочном формате для описания покупки используется несколько строк. Для строк транзакций используется один формат, а для приобретенных товарных единиц – другой. Журналы ELF2 имеют многострочный формат. Просмотрите свои журналы электронной торговли, чтобы понять, в каком формате приведены данные – многострочном или однострочном, поскольку это повлияет на способ настройки пользовательского формата журнала. В зависимости от типа формата журнала выполните описанные ниже действия.

'''Общие рекомендации относительно журналов электронной торговли'''

Вне зависимости от того, в каком формате создаются записи журнала в вашей корзине покупок, для корреляции посетителей каждое вхождение должно содержать дату и время по крайней мере в одном из следующих полей:

  * Remote Host or IP Address (Удаленный хост или IP-адрес) – для методов отслеживания посетителей только по IP или с помощью комбинации IP и агента пользователя.
  * Useragent (Агент пользователя) – для метода отслеживания посетителей с помощью комбинации IP и агента пользователя.
  * Cookies (Файлы cookie) – для метода отслеживания посетителей через систему UTM или по идентификатору сеанса.
  * Session ID (идентификатор сеанса) – для метода отслеживания посетителей по идентификатору сеанса.

При отсутствии одного из вышеуказанных полей Urchin не сможет выполнить анализ ваших доходов. Urchin также определяет следующие поля электронной торговли:

  * %{ORDERID} – номер заказа.
  * %{STORE} – название или идентификатор электронного магазина.
  * %{SESSIONID} – уникальный идентификатор сеанса покупателя.
  * %{TOTAL} – итоговая сумма транзакции с учетом налогов и стоимости доставки (только десятичные числа, без символов '$').

  * %{TAX} – сумма налога, добавленного к промежуточному итогу.

  * %{SHIPPING} – стоимость доставки.
  * %{BILL\_CITY} – город платежного адреса покупателя.
  * %{BILL\_STATE} – область или регион платежного адреса покупателя.
  * %{BILL\_ZIP} – почтовый индекс платежного адреса покупателя.
  * %{BILL\_COUNTRY} – страна платежного адреса покупателя.
  * %{PRODUCT\_CODE} – идентификационный номер товара.
  * %{PRODUCT\_NAME} – идентификационное название товара.
  * %{VARIATION} – вариант товара (цвет, размер и т. д.).
  * %{PRICE} - цена за единицу товара (только десятичные числа, без символов '$').
  * %{QUANTITY} – заказанное количество данного товара.
  * %{UPSOLD} – логическое значение (0|1), указывающее, имеется ли товар в продаже.


'''Однострочные форматы журнала'''

Если ваш файл журнала электронной торговли содержит обращения в однострочном формате, как описано выше, следуйте этим инструкциям.

  1. Создайте новый пользовательский формат журнала в каталоге lib/custom/logformats, сделав копию файла custom.lf.sample. Присвойте этой копии имя с суффиксом .lf.
> 2. Отредактируйте свой новый файл пользовательского формата журнала с учетом приведенных ниже рекомендаций.
    * 

> PrimaryPositions. Эта запись определяет порядок следования полей в файле журнала. Создайте список, разделяя идентификаторы полей запятыми, чтобы задать нужный порядок. Названия и идентификаторы полей можно найти в файле lib/reporting/logformats/fieldlist.txt. См пример ниже.
  * 

> SecondaryPositions. Оставьте в этом поле прочерк ('-'), поскольку эта запись не используется для файлов журнала в однострочном формате.
  * 

> PrimaryKey. Оставьте в этом поле прочерк ('-'), поскольку эта запись не используется для файлов журнала в однострочном формате.
  * 

> SecondaryKey. Оставьте в этом поле прочерк ('-'), поскольку эта запись не используется для файлов журнала в однострочном формате.
  * 

> PrimaryContent. Действительные значения для этого поля: TRANSACTION или ITEM. Если обращения в вашем файле журнала относятся к покупке каждого отдельного товара, задайте значение ITEM. Если же они относятся к покупке в целом, укажите значение TRANSACTION.
  * 

> SecondaryContent. Оставьте в этом поле прочерк ('-'), поскольку эта запись не используется для файлов журнала в однострочном формате.
  * 

> CommentKey. Если некоторые строки в вашем файле журнала являются комментариями или не рассматриваются как обращения и начинаются с определенного символа, укажите здесь этот символ.
  * 

> FieldSeparator1. Позволяет указать, какие символы используются в качестве разделителей полей. Обычно это символы табуляции (\t) и пробела (\s). Укажите здесь символы, которые используются для разделения полей в вашем файле журнала.
  * 

> FieldSeparator2. См. FieldSeparator1 выше.
  * 

> QuotesEscapeSep. Позволяет указать, будут ли игнорироваться разделители полей в поле, содержащем кавычки. Можно оставить значение YES (ДА).
  * 

> BracketsEscapeSep. Позволяет указать, будут ли игнорироваться разделители полей в поле, содержащем квадратные скобки. Можно оставить значение YES (ДА).
  * 

> MergSuccessiveSep. Позволяет указать, следует ли рассматривать два символа разделителя подряд как один. Можно оставить значение NO (НЕТ).
  * 

> CleanWhiteSpace. Позволяет указать, следует ли удалять пробелы в конце полей при синтаксическом анализе. Можно оставить значение NO (НЕТ).
  * 

> StatusRequired. Оставьте значение NO (НЕТ), если только обращения не содержат статусные коды типа веб-сервера.
  * 

> CustomDateFormat. Если формат журнала содержит пользовательский формат даты, задайте соответствующий формат strptime.
  * 

> CustomTimeFormat. Если формат журнала содержит пользовательский формат времени, задайте соответствующий формат strptime.
> 3. Сохраните свой пользовательский формат журнала в каталоге lib/custom/logformats.
> 4. Выберите для источника журналов пользовательский формат журнала в интерфейсе администрирования Urchin.
> 5. Выполните обработку файлов журнала в Urchin.

'''Однострочный формат: пример'''

Ниже приведен пример отдельного обращения из журнала, содержащего только данные о транзакциях.
```
12345 123.123.123.123 "Urchin Store" [26/Aug/2003:11:43:02 -0700] 192.73 "San Diego" "CA" 92101 "US" "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;)" "utma=171060324.2734232095.1061444425.1061444425.1061444763.2"
```
В приведенном ниже списке перечислены названия полей с идентификационными номерами, полученными из файла lib/reporting/logformats/fieldslist.txt. Идентификационные номера, назначенные таким образом, используются в поле PrimaryPositions в файле пользовательского формата журнала.

  1. Идентификатор транзакции: 25
> 2. Удаленный хост или IP-адрес: 12
> 3. Название магазина: 26
> 4. Дата/время в формате Apache: 3
> 5. Итоговая стоимость: 28
> 6. Город покупателя: 31
> 7. Регион покупателя: 32
> 8. Почтовый индекс покупателя: 33
> 9. Страна покупателя: 34

  1. Агент пользователя: 13
> 2. Файлы сookie: 14

Исходя из представленного выше списка необходимо определить в файле пользовательского формата журнала следующие записи:
```
PrimaryPositions: "25, 12, 26, 3, 28, 31, 32, 33, 34, 13, 14" SecondaryPositions: - PrimaryKey: - SecondaryKey: - PrimaryContent: TRANSACTION SecondaryContent: - CommentKey: # FieldSeparator1: \s FieldSeparator2: \t QuotesEscapeSep: YES BracketsEscapeSep: YES MergSuccessiveSep: NO CleanWhiteSpace: NO StatusRequired: NO CustomDateFormat: - CustomTimeFormat: -
```
PrimaryPositions указывает порядок полей, PrimaryContent сообщает программе Urchin, что в этом журнале содержатся транзакции (или общая информация о покупках). В качестве разделителей полей заданы пробел и табуляция, поскольку поля были разделены пробелом. Пользовательские форматы даты/времени не указаны, так как для них используется формат Apache.

'''Многострочные форматы журналов'''

Urchin распознает многострочные форматы, если в начале каждой строки содержится определенный символ, указывающий на используемый формат. Например, файлы журнала ELF2 содержат восклицательный знак ('!'), с которого начинается каждая строка транзакции. Строки товарных единиц НЕ содержат восклицательный знак ('!').

Если файл журнала электронной торговли содержит две строки в разных форматах (одну для транзакций, а другую – для товара или товарных единиц), следуйте этим инструкциям.

  1. Создайте новый пользовательский формат журнала в каталоге lib/custom/logformats, сделав копию файла custom.lf.sample. Присвойте этой копии имя с суффиксом .lf.
> 2. Отредактируйте новый файл пользовательского формата журнала с учетом приведенных ниже рекомендаций.
    * 

> PrimaryPositions. Эта запись определяет порядок следования полей в файле журнала. Создайте список, разделяя идентификаторы полей запятыми, чтобы задать нужный порядок. Названия полей и идентификаторы можно найти в файле lib/reporting/logformats/fieldlist.txt.
  * 

> SecondaryPositions. Эта запись определяет порядок следования полей в файле журнала. Создайте список, разделяя идентификаторы полей запятыми, чтобы задать нужный порядок. Названия полей и идентификаторы можно найти в файле lib/reporting/logformats/fieldlist.txt.
  * 

> PrimaryKey. Укажите символ, определяющий тот же формат строки файла журнала, который задан для PrimaryPositions.
  * 

> SecondaryKey. Укажите символ, определяющий тот же формат строки файла журнала, который задан для SecondaryPositions.
  * 

> PrimaryContent. Действительные значения для этого поля: TRANSACTION или ITEM. Если обращения в вашем файле журнала относятся к покупке каждого отдельного товара, задайте значение ITEM. Если же они относятся к покупке в целом, укажите значение TRANSACTION.
  * 

> SecondaryContent. См. PrimaryContent выше.
  * 

> CommentKey. Если некоторые строки в вашем файле журнала являются комментариями или не рассматриваются как обращения и начинаются с определенного символа, укажите здесь этот символ.
  * 

> FieldSeparator1. Позволяет указать, какие символы используются в качестве разделителей полей. Обычно это символы табуляции (\t) и пробела (\s). Укажите здесь символы, которые используются для разделения полей в вашем файле журнала.
  * 

> FieldSeparator2. См. FieldSeparator1 выше.
  * 

> QuotesEscapeSep. Позволяет указать, будут ли игнорироваться разделители полей в поле, содержащем кавычки. Можно оставить значение YES (ДА).
  * 

> BracketsEscapeSep. Позволяет указать, будут ли игнорироваться разделители полей в поле, содержащем квадратные скобки. Можно оставить значение YES (ДА).
  * 

> MergSuccessiveSep. Позволяет указать, следует ли рассматривать два символа разделителя подряд как один. Можно оставить значение NO (НЕТ).
  * 

> CleanWhiteSpace. Позволяет указать, следует ли удалять пробелы в конце полей при синтаксическом анализе. Можно оставить значение NO (НЕТ).
  * 

> StatusRequired. Оставьте значение NO (НЕТ), если только обращения не содержат статусные коды типа веб-сервера.
  * 

> CustomDateFormat. Если формат журнала содержит пользовательский формат даты, задайте соответствующий формат strptime.
  * 

> CustomTimeFormat. Если формат журнала содержит пользовательский формат времени, задайте соответствующий формат strptime.
> 3. Сохраните свой пользовательский формат журнала в каталоге lib/custom/logformats.
> 4. Выберите для источника журналов пользовательский формат журнала в интерфейсе администрирования Urchin.
> 5. Выполните обработку файлов журнала в Urchin.